
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inspector PCB Industrial</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
}

header {
  padding: 8px;
  background: #1e293b;
  display: flex;
  gap: 8px;
  align-items: center;
}

button {
  padding: 8px 12px;
  background: #2563eb;
  border: none;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}

#workspace {
  position: relative;
  width: 100%;
  height: calc(100vh - 50px);
  overflow: hidden;
}

#pcbImage {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

.component {
  position: absolute;
  border: 2px solid #22c55e;
  border-radius: 4px;
  cursor: pointer;
}

#defectMenu {
  position: absolute;
  background: #0f172a;
  border: 1px solid #334155;
  padding: 6px;
  display: none;
  z-index: 10;
  width: 220px;
}

.defect-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.defect-btn {
  background: #334155;
  padding: 6px;
  text-align: center;
  border-radius: 4px;
  cursor: pointer;
}

.defect-btn:hover {
  background: #475569;
}
</style>
</head>

<body>

<header>
  <button onclick="loadImage()">Cargar placa</button>
  <button onclick="exportToExcel()">Exportar Excel</button>
</header>

<div id="workspace">
  <img id="pcbImage">
</div>

<div id="defectMenu">
  <div class="defect-grid">
    <div class="defect-btn" onclick="registerDefect('faltante')">Faltante</div>
    <div class="defect-btn" onclick="registerDefect('invertido')">Invertido</div>
    <div class="defect-btn" onclick="registerDefect('levantado')">Levantado</div>
    <div class="defect-btn" onclick="registerDefect('desplazado')">Desplazado</div>
    <div class="defect-btn" onclick="registerDefect('mal_insertado')">Mal insertado</div>
    <div class="defect-btn" onclick="registerDefect('suelto')">Suelto</div>
    <div class="defect-btn" onclick="registerDefect('equivocado')">Equivocado</div>
    <div class="defect-btn" onclick="registerDefect('roto')">Roto</div>
  </div>
</div>

<script>
let defects = JSON.parse(localStorage.getItem("pcb_defects") || "{}");
let selectedComponent = null;

const components = [
  { id: "R1", name: "R1", x: 30, y: 40, w: 5, h: 3 },
  { id: "C3", name: "C3", x: 55, y: 60, w: 5, h: 3 }
];

function loadImage() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    const file = e.target.files[0];
    const img = document.getElementById("pcbImage");
    img.src = URL.createObjectURL(file);
    renderComponents();
  };
  input.click();
}

function renderComponents() {
  const ws = document.getElementById("workspace");
  ws.querySelectorAll(".component").forEach(e => e.remove());

  components.forEach(c => {
    const div = document.createElement("div");
    div.className = "component";
    div.style.left = c.x + "%";
    div.style.top = c.y + "%";
    div.style.width = c.w + "%";
    div.style.height = c.h + "%";
    div.onclick = ev => openDefectMenu(ev, c.id);
    ws.appendChild(div);
  });
}

function openDefectMenu(ev, compId) {
  selectedComponent = compId;
  const menu = document.getElementById("defectMenu");
  menu.style.display = "block";

  const rect = menu.getBoundingClientRect();
  let x = ev.clientX;
  let y = ev.clientY;

  if (x + rect.width > window.innerWidth) {
    x = window.innerWidth - rect.width - 10;
  }
  if (y + rect.height > window.innerHeight) {
    y = window.innerHeight - rect.height - 10;
  }

  menu.style.left = x + "px";
  menu.style.top = y + "px";
}

function registerDefect(type) {
  if (!selectedComponent) return;

  defects[selectedComponent] = defects[selectedComponent] || [];
  defects[selectedComponent].push({
    type,
    timestamp: Date.now()
  });

  localStorage.setItem("pcb_defects", JSON.stringify(defects));
  document.getElementById("defectMenu").style.display = "none";
}

function exportToExcel() {
  const rows = [];
  Object.entries(defects).forEach(([comp, list]) => {
    list.forEach(d => {
      rows.push({
        Componente: comp,
        Defecto: d.type,
        Hora: new Date(d.timestamp).toLocaleTimeString()
      });
    });
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Defectos");
  XLSX.writeFile(wb, "Defectos_PCB.xlsx");
}
</script>

</body>
</html>
