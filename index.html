<!DOCTYPE html>
<html lang="es">
<head>
<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Inspector PCB</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        #root { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        window.storage = {
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { key, value } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            },
            async delete(key) {
                localStorage.removeItem(key);
                return { key, deleted: true };
            },
            async list(prefix) {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!prefix || key.startsWith(prefix)) {
                        keys.push(key);
                    }
                }
                return { keys };
            }
        };

        const { useState, useEffect, useRef } = React;
        
        const PCBDefectInspector = () => {
          const [models, setModels] = useState([]);
          const [currentModel, setCurrentModel] = useState(null);
          const [view, setView] = useState('select');
          const [buttons, setButtons] = useState([]);
          const [defects, setDefects] = useState({});
          const [selectedButton, setSelectedButton] = useState(null);
          const [showDefectMenu, setShowDefectMenu] = useState(false);
          const [menuPosition, setMenuPosition] = useState({ x: 0, y: 0 });
          const [showNameDialog, setShowNameDialog] = useState(false);
          const [tempImage, setTempImage] = useState(null);
          const [modelNameInput, setModelNameInput] = useState('');
          const [showAddButton, setShowAddButton] = useState(false);
          const [newButtonName, setNewButtonName] = useState('');
          const [editingButton, setEditingButton] = useState(null);
          const [showEditDialog, setShowEditDialog] = useState(false);
          const [editForm, setEditForm] = useState({ width: 50, height: 30 });
          const [isDragging, setIsDragging] = useState(false);
          const [draggedButton, setDraggedButton] = useState(null);
          const [showSidebar, setShowSidebar] = useState(false);
          
          // NUEVO: Estado para el modo de edición/movimiento
          const [isEditMode, setIsEditMode] = useState(false);

          const imageRef = useRef(null);
          const containerRef = useRef(null);
          // const longPressTimer = useRef(null); // ELIMINADO: Ya no se usa

          useEffect(() => {
            loadData();
          }, []);

          useEffect(() => {
            if (models.length > 0 || buttons.length > 0 || Object.keys(defects).length > 0) {
              saveData();
            }
          }, [models, buttons, defects, currentModel]);

          const loadData = async () => {
            try {
              const modelsData = await window.storage.get('pcb_models');
              const buttonsData = await window.storage.get('pcb_buttons');
              const defectsData = await window.storage.get('pcb_defects');
              const currentData = await window.storage.get('pcb_current');

              if (modelsData) setModels(JSON.parse(modelsData.value));
              if (buttonsData) setButtons(JSON.parse(buttonsData.value));
              if (defectsData) setDefects(JSON.parse(defectsData.value));
              if (currentData) setCurrentModel(currentData.value);
            } catch (error) {
              console.log('Iniciando con datos nuevos');
            }
          };

          const saveData = async () => {
            try {
              await window.storage.set('pcb_models', JSON.stringify(models));
              await window.storage.set('pcb_buttons', JSON.stringify(buttons));
              await window.storage.set('pcb_defects', JSON.stringify(defects));
              if (currentModel) {
                await window.storage.set('pcb_current', currentModel);
              }
            } catch (error) {
              console.error('Error al guardar:', error);
            }
          };

          const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                setTempImage(event.target.result);
                setShowNameDialog(true);
              };
              reader.readAsDataURL(file);
            }
          };

          const saveModel = () => {
            if (!modelNameInput.trim()) {
              alert('Por favor ingrese un nombre para la placa');
              return;
            }
            
            const newModel = {
              id: Date.now().toString(),
              name: modelNameInput.trim(),
              image: tempImage
            };
            setModels([...models, newModel]);
            setShowNameDialog(false);
            setModelNameInput('');
            setTempImage(null);
          };

          const selectModel = (modelId) => {
            setCurrentModel(modelId);
            setView('inspect');
            if (!defects[modelId]) {
              setDefects({ ...defects, [modelId]: {} });
            }
          };

          const getCurrentModelButtons = () => {
            return buttons.filter(b => b.modelId === currentModel);
          };

          const getCurrentModel = () => {
            return models.find(m => m.id === currentModel);
          };

          const getButtonDefectCount = (buttonId) => {
            const modelDefects = defects[currentModel] || {};
            const faltantes = modelDefects[`${buttonId}_faltante`] || 0;
            const levantados = modelDefects[`${buttonId}_levantado`] || 0;
            return { faltantes, levantados, total: faltantes + levantados };
          };

          const getSortedButtons = () => {
            return getCurrentModelButtons()
              .map(button => ({
                ...button,
                ...getButtonDefectCount(button.id)
              }))
              .sort((a, b) => b.total - a.total);
          };

          // LÓGICA DE INTERACCIÓN UNIFICADA Y MODIFICADA
          const handleButtonClick = (button, e) => {
            e.stopPropagation();
            
            if (isDragging) return; // Si estamos terminando un arrastre, ignorar el click

            if (isEditMode) {
                // MODO EDICIÓN: Click/Tap abre el diálogo de edición
                setEditingButton(button);
                setEditForm({
                  width: button.width || 50,
                  height: button.height || 30
                });
                setShowEditDialog(true);
                return;
            }
            
            // MODO INSPECCIÓN: Click/Tap abre el menú de defectos
            const rect = e.currentTarget.getBoundingClientRect();
            setSelectedButton(button);
            setMenuPosition({
              x: rect.left + rect.width / 2,
              y: rect.top + rect.height / 2
            });
            setShowDefectMenu(true);
          };

          const getPositionOnImage = (clientX, clientY) => {
            if (!imageRef.current) return null;
            
            const imgRect = imageRef.current.getBoundingClientRect();
            // Calcular posición relativa al 100% del ancho/alto de la imagen
            const x = ((clientX - imgRect.left) / imgRect.width) * 100;
            const y = ((clientY - imgRect.top) / imgRect.height) * 100;
            
            return {
              // Asegurar que no se salga de los límites de la imagen (de 2% a 98% para un pequeño margen)
              x: Math.max(2, Math.min(98, x)), 
              y: Math.max(2, Math.min(98, y))
            };
          };

          // NUEVO: Inicio de arrastre unificado (Ratón/Táctil)
          const handleDragStart = (button, e) => {
            if (!isEditMode) return;
            // Solo permitir el inicio del arrastre si es clic izquierdo (ratón) o evento táctil
            if (e.button !== 0 && !e.touches) return;

            e.preventDefault(); // Evita scroll y menú contextual
            e.stopPropagation();
            
            setIsDragging(true);
            setDraggedButton(button.id);
          };

          // MOVIMIENTO PARA RATÓN
          const handleMouseMove = (e) => {
            if (!isDragging || !draggedButton || !isEditMode) return;
            
            const pos = getPositionOnImage(e.clientX, e.clientY);
            if (!pos) return;
            
            setButtons(prevButtons => prevButtons.map(b => 
              b.id === draggedButton ? { ...b, x: pos.x, y: pos.y } : b
            ));
          };

          // NUEVO: MOVIMIENTO PARA TÁCTIL
          const handleTouchMove = (e) => {
            if (!isDragging || !draggedButton || !isEditMode) return;
            if (e.touches.length !== 1) return; // Solo arrastre con un dedo
            
            e.preventDefault(); 
            
            const touch = e.touches[0];
            const pos = getPositionOnImage(touch.clientX, touch.clientY);
            if (!pos) return;
            
            setButtons(prevButtons => prevButtons.map(b => 
              b.id === draggedButton ? { ...b, x: pos.x, y: pos.y } : b
            ));
          };

          // FIN DE ARRASTRE UNIFICADO
          const handleMouseUp = (e) => {
            if (isDragging && draggedButton) {
              setIsDragging(false);
              setDraggedButton(null);
            }
          };

          // ELIMINADO: handleRightMouseDown (reemplazado por Modo Edición)
          // ELIMINADO: handleLongPress, handleLongPressEnd (reemplazado por Modo Edición + Click simple)


          const registerDefect = (type) => {
            const key = `${selectedButton.id}_${type}`;
            const modelDefects = defects[currentModel] || {};
            const count = (modelDefects[key] || 0) + 1;
            
            setDefects({
              ...defects,
              [currentModel]: {
                ...modelDefects,
                [key]: count
              }
            });
            
            setShowDefectMenu(false);
            setSelectedButton(null);
          };

          const createButtonFromDrop = (e) => {
            if (!newButtonName.trim()) return;

            const pos = getPositionOnImage(e.clientX, e.clientY);
            if (!pos) return;
            
            const newButton = {
              id: Date.now().toString(),
              modelId: currentModel,
              name: newButtonName.trim(),
              x: pos.x,
              y: pos.y,
              width: 50,
              height: 30
            };
            
            setButtons([...buttons, newButton]);
            setNewButtonName('');
            setShowAddButton(false);
          };

          const deleteButton = (buttonId) => {
            if (confirm('¿Eliminar este componente?')) {
              setButtons(buttons.filter(b => b.id !== buttonId));
              const modelDefects = { ...defects[currentModel] };
              Object.keys(modelDefects).forEach(key => {
                if (key.startsWith(buttonId)) {
                  delete modelDefects[key];
                }
              });
              setDefects({ ...defects, [currentModel]: modelDefects });
            }
          };

          const updateButtonStyle = () => {
            setButtons(buttons.map(b => 
              b.id === editingButton.id 
                ? { ...b, width: editForm.width, height: editForm.height }
                : b
            ));
            setShowEditDialog(false);
            setEditingButton(null);
          };

          const exportToExcel = () => {
            const model = getCurrentModel();
            const modelDefects = defects[currentModel] || {};
            
            let csv = 'Modelo,Componente,Defecto,Cantidad\n';
            
            getCurrentModelButtons().forEach(button => {
              const faltantes = modelDefects[`${button.id}_faltante`] || 0;
              const levantados = modelDefects[`${button.id}_levantado`] || 0;
              
              if (faltantes > 0) {
                csv += `${model.name},${button.name},Faltante,${faltantes}\n`;
              }
              if (levantados > 0) {
                csv += `${model.name},${button.name},Levantado,${levantados}\n`;
              }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `defectos_${model.name}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
          };

          const getDefectColor = (count) => {
            if (count === 0) return 'rgba(0, 200, 0, 0.3)';
            if (count <= 2) return 'rgba(255, 255, 0, 0.5)';
            if (count <= 5) return 'rgba(255, 150, 0, 0.6)';
            return 'rgba(255, 0, 0, 0.8)';
          };

          const Upload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
          const Plus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
          const BarChart3 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
          const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
          const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
          const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
          const GripVertical = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>;
          const Menu = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
          const Settings = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;

          const renderHeatmap = () => {
            const model = getCurrentModel();
            const modelDefects = defects[currentModel] || {};
            
            return (
              <div className="fixed inset-0 bg-black z-50">
                <div className="h-full flex flex-col">
                  <div className="bg-gray-900 p-4 flex justify-between items-center">
                    <h2 className="text-white text-xl font-bold">Mapa de Calor - {model.name}</h2>
                    <button
                      onClick={() => setView('inspect')}
                      className="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600 flex items-center gap-2"
                    >
                      <X /> Cerrar
                    </button>
                  </div>
                  
                  <div className="flex-1 overflow-auto p-4 bg-gray-800">
                    <div className="relative inline-block max-w-full">
                      <img
                        src={model.image}
                        alt={model.name}
                        className="max-w-full h-auto"
                      />
                      {getCurrentModelButtons().map(button => {
                        const faltantes = modelDefects[`${button.id}_faltante`] || 0;
                        const levantados = modelDefects[`${button.id}_levantado`] || 0;
                        const total = faltantes + levantados;
                        
                        return (
                          <div
                            key={button.id}
                            style={{
                              position: 'absolute',
                              left: `${button.x}%`,
                              top: `${button.y}%`,
                              transform: 'translate(-50%, -50%)'
                            }}
                          >
                            <div
                              className="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-sm border-2 border-white shadow-lg"
                              style={{ backgroundColor: getDefectColor(total) }}
                            >
                              {total}
                            </div>
                            <div className="bg-black bg-opacity-90 text-white text-xs p-2 rounded mt-1 whitespace-nowrap">
                              <div className="font-bold">{button.name}</div>
                              <div className="text-red-400">Faltantes: {faltantes}</div>
                              <div className="text-orange-400">Levantados: {levantados}</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          if (showNameDialog) {
            return (
              <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg p-6 max-w-md w-full">
                  <h2 className="text-2xl font-bold mb-4">Nombre de la Placa</h2>
                  <div className="mb-4">
                    <img src={tempImage} alt="Preview" className="w-full rounded border-2 border-gray-300 mb-4" />
                  </div>
                  <input
                    type="text"
                    value={modelNameInput}
                    onChange={(e) => setModelNameInput(e.target.value)}
                    placeholder="Ej: PCB-2024-V1"
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg"
                    autoFocus
                    onKeyPress={(e) => e.key === 'Enter' && saveModel()}
                  />
                  <div className="flex gap-2">
                    <button
                      onClick={saveModel}
                      className="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold"
                    >
                      Guardar
                    </button>
                    <button
                      onClick={() => {
                        setShowNameDialog(false);
                        setModelNameInput('');
                        setTempImage(null);
                      }}
                      className="flex-1 bg-gray-400 text-white py-3 rounded-lg hover:bg-gray-500 font-bold"
                    >
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          if (showEditDialog && editingButton) {
            return (
              <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg p-6 max-w-md w-full">
                  <h2 className="text-2xl font-bold mb-4">Editar: {editingButton.name}</h2>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-bold mb-2">Ancho (px)</label>
                    <input
                      type="range"
                      min="30"
                      max="150"
                      value={editForm.width}
                      onChange={(e) => setEditForm({ ...editForm, width: parseInt(e.target.value) })}
                      className="w-full"
                    />
                    <div className="text-center text-gray-600">{editForm.width}px</div>
                  </div>

                  <div className="mb-4">
                    <label className="block text-sm font-bold mb-2">Alto (px)</label>
                    <input
                      type="range"
                      min="20"
                      max="100"
                      value={editForm.height}
                      onChange={(e) => setEditForm({ ...editForm, height: parseInt(e.target.value) })}
                      className="w-full"
                    />
                    <div className="text-center text-gray-600">{editForm.height}px</div>
                  </div>

                  <div className="mb-4 p-4 bg-gray-100 rounded flex items-center justify-center">
                    <div
                      className="bg-blue-500 text-white flex items-center justify-center font-bold rounded-lg border-2 border-white"
                      style={{ width: `${editForm.width}px`, height: `${editForm.height}px`, fontSize: '11px' }}
                    >
                      {editingButton.name}
                    </div>
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={updateButtonStyle}
                      className="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold flex items-center justify-center gap-2"
                    >
                      Confirmar
                    </button>
                    <button
                      onClick={() => {
                        deleteButton(editingButton.id);
                        setShowEditDialog(false);
                      }}
                      className="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-bold flex items-center gap-2"
                    >
                      <Trash2 /> Eliminar
                    </button>
                    <button
                      onClick={() => {
                        setShowEditDialog(false);
                        setEditingButton(null);
                      }}
                      className="bg-gray-400 text-white px-4 py-3 rounded-lg hover:bg-gray-500 font-bold"
                    >
                      <X />
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'heatmap') {
            return renderHeatmap();
          }

          if (view === 'select') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 p-4">
                <div className="max-w-4xl mx-auto">
                  <h1 className="text-4xl font-bold text-white mb-8 text-center">
                    Inspector de Defectos PCB
                  </h1>
                  
                  <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                    <label className="flex items-center justify-center gap-3 cursor-pointer bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-lg transition">
                      <Upload />
                      <span className="text-lg font-semibold">Cargar Nueva Placa</span>
                      <input
                        type="file"
                        accept="image/jpeg,image/jpg"
                        onChange={handleImageUpload}
                        className="hidden"
                      />
                    </label>
                  </div>

                  {models.length === 0 ? (
                    <div className="bg-white bg-opacity-20 rounded-lg p-8 text-center text-white">
                      <div className="flex justify-center mb-4"><Upload /></div>
                      <h2 className="text-2xl font-bold mb-2">No hay placas cargadas</h2>
                      <p className="text-lg">Haz clic en "Cargar Nueva Placa" para comenzar</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {models.map(model => (
                        <div
                          key={model.id}
                          className="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition"
                        >
                          <div 
                            onClick={() => selectModel(model.id)}
                            className="cursor-pointer"
                          >
                            <img
                              src={model.image}
                              alt={model.name}
                              className="w-full h-48 object-cover"
                            />
                            <div className="p-4">
                              <h3 className="text-lg font-bold text-gray-800">{model.name}</h3>
                            </div>
                          </div>
                          <div className="px-4 pb-4">
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                if (confirm('¿Eliminar esta placa y todos sus datos?')) {
                                  setModels(models.filter(m => m.id !== model.id));
                                  setButtons(buttons.filter(b => b.modelId !== model.id));
                                  const newDefects = { ...defects };
                                  delete newDefects[model.id];
                                  setDefects(newDefects);
                                }
                              }}
                              className="text-red-600 hover:text-red-800 text-sm font-semibold"
                            >
                              <Trash2 style={{display:'inline', width:'16px', height:'16px', marginRight:'4px'}} />
                              Eliminar
                            </button>
                          </div>
                      </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      }

      if (view === 'inspect') {
        const model = getCurrentModel();
        const sortedButtons = getSortedButtons();
        
        return (
          <div className="fixed inset-0 bg-black flex">
            <div 
              className={`absolute top-0 left-0 h-full bg-gray-900 transition-transform duration-300 z-40 ${showSidebar ? 'translate-x-0' : '-translate-x-full'}`}
              style={{ width: '160px' }}
            >
              <div className="bg-gray-800 p-2 flex justify-between items-center">
                <h3 className="text-white font-bold text-xs">Defectos</h3>
                <button
                  onClick={() => setShowSidebar(false)}
                  className="text-white hover:bg-gray-700 p-1 rounded"
                >
                  <X style={{width:'16px',height:'16px'}} />
                </button>
              </div>
              <div className="overflow-y-auto" style={{ height: 'calc(100% - 40px)' }}>
                {sortedButtons.map(button => (
                  <div
                    key={button.id}
                    className="p-2 border-b border-gray-700 hover:bg-gray-800 cursor-pointer text-white text-xs"
                    onClick={() => {
                      setShowSidebar(false);
                    }}
                  >
                    <div className="font-bold mb-1 truncate">{button.name}</div>
                    <div className="grid grid-cols-3 gap-1 text-xs">
                      <span className="text-red-400">F:{button.faltantes}</span>
                      <span className="text-orange-400">L:{button.levantados}</span>
                      <span className="text-yellow-400">T:{button.total}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="flex-1 flex flex-col">
              <div className="bg-gray-900 p-2 flex justify-between items-center flex-shrink-0">
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowSidebar(!showSidebar)}
                    className="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-600"
                  >
                    <Menu />
                  </button>
                  <button
                    onClick={() => setView('select')}
                    className="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600"
                  >
                    ← Volver
                  </button>
                </div>
                
                <span className="text-white font-bold text-lg">{model.name}</span>
                
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowAddButton(!showAddButton)}
                    className={`px-4 py-2 rounded ${showAddButton ? 'bg-green-600' : 'bg-blue-600'} text-white hover:opacity-80`}
                    title="Agregar Componente"
                  >
                    <Plus />
                  </button>
                  
                  {/* NUEVO BOTÓN PARA MODO EDICIÓN/MOVIMIENTO */}
                  <button
                    onClick={() => {
                      setIsEditMode(!isEditMode);
                      setShowDefectMenu(false); // Cierra cualquier menú abierto
                      setShowAddButton(false);  // Cierra modo añadir
                    }}
                    className={`px-4 py-2 rounded ${isEditMode ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-gray-700 hover:bg-gray-600'} text-white`}
                    title="Modo Edición (Mover/Ajustar Componentes)"
                  >
                    <Settings />
                  </button>
                  
                  <button
                    onClick={() => setView('heatmap')}
                    className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                    title="Mapa de Calor"
                  >
                    <BarChart3 />
                  </button>
                  <button
                    onClick={exportToExcel}
                    className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                    title="Exportar a Excel"
                  >
                    <Download />
                  </button>
                </div>
              </div>

              {showAddButton && (
                <div className="bg-green-600 p-3 flex gap-2 items-center flex-shrink-0">
                  <GripVertical />
                  <input
                    type="text"
                    value={newButtonName}
                    onChange={(e) => setNewButtonName(e.target.value)}
                    placeholder="Nombre (ej: C1, R5)"
                    className="px-3 py-2 rounded flex-1"
                    autoFocus
                  />
                  <span className="text-white text-sm">← Arrastra</span>
                </div>
              )}
              
              {/* Contenedor principal para la imagen y botones */}
              <div 
                ref={containerRef}
                className="flex-1 relative overflow-auto bg-gray-900"
                onClick={() => showDefectMenu && setShowDefectMenu(false)}
                onMouseMove={handleMouseMove}
                onMouseUp={handleMouseUp}
                onMouseLeave={handleMouseUp}
                onContextMenu={(e) => e.preventDefault()}
                onDrop={(e) => {
                  e.preventDefault();
                  if (showAddButton && newButtonName.trim()) {
                    createButtonFromDrop(e);
                  }
                }}
                onDragOver={(e) => e.preventDefault()}
                // NUEVOS MANEJADORES TÁCTILES
                onTouchMove={handleTouchMove}
                onTouchEnd={handleMouseUp}
              >
                <img
                  ref={imageRef}
                  src={model.image}
                  alt={model.name}
                  className="w-full h-full object-contain pointer-events-none"
                  style={{ userSelect: 'none' }}
                />
                
                {getCurrentModelButtons().map(button => {
                  const isBeingDragged = draggedButton === button.id;
                  
                  return (
                    <div
                      key={button.id}
                      style={{
                        position: 'absolute',
                        left: `${button.x}%`,
                        top: `${button.y}%`,
                        transform: 'translate(-50%, -50%)',
                        pointerEvents: 'auto'
                      }}
                    >
                      <button
                        className={`bg-blue-500 text-white shadow-lg transition font-bold border-2 rounded-lg ${isBeingDragged ? 'bg-opacity-90 border-yellow-400 border-4' : 'bg-opacity-60 hover:bg-opacity-80'} ${isEditMode ? 'border-yellow-400 border-dashed border-2 cursor-grab' : 'border-white cursor-pointer'}`}
                        style={{
                          width: `${button.width || 50}px`,
                          height: `${button.height || 30}px`,
                          fontSize: '11px',
                          // NEW: cursor cambia en modo edición
                          cursor: isEditMode ? (isBeingDragged ? 'grabbing' : 'grab') : 'pointer'
                        }}
                        onClick={(e) => handleButtonClick(button, e)}
                        // NUEVOS MANEJADORES PARA INICIAR EL ARRASTRE
                        onMouseDown={(e) => handleDragStart(button, e)} // Click normal (izquierdo) para arrastrar en modo edición
                        onTouchStart={(e) => handleDragStart(button, e)}
                        // ELIMINADAS: onMouseUp, onContextMenu, onTouchStart para long press
                      >
                        {button.name}
                        {isEditMode && <Settings style={{width: '12px', height: '12px', marginLeft: '4px', display: 'inline'}} />}
                      </button>
                    </div>
                  );
                })}

                {showAddButton && newButtonName.trim() && (
                  <div className="absolute inset-0 border-4 border-dashed border-green-400 pointer-events-none flex items-center justify-center">
                    <div className="bg-green-600 text-white p-6 rounded-lg text-center">
                      <div className="flex justify-center mb-2"><GripVertical /></div>
                      <p className="text-xl font-bold">Suelta aquí "{newButtonName}"</p>
                    </div>
                  </div>
                )}
              </div>

              {showDefectMenu && !isDragging && (
                <div
                  className="fixed z-50"
                  style={{
                    left: menuPosition.x,
                    top: menuPosition.y,
                    transform: 'translate(-50%, -50%)'
                  }}
                >
                  <div className="flex gap-3">
                    <button
                      onClick={() => registerDefect('faltante')}
                      className="bg-red-600 text-white px-8 py-5 rounded-lg shadow-2xl hover:bg-red-700 font-bold text-xl"
                    >
                      Faltante
                    </button>
                    <button
                      onClick={() => registerDefect('levantado')}
                      className="bg-orange-600 text-white px-8 py-5 rounded-lg shadow-2xl hover:bg-orange-700 font-bold text-xl"
                    >
                      Levantado
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      return null;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PCBDefectInspector />);
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('✅ Service Worker registrado'))
                .catch(err => console.log('❌ Error al registrar SW:', err));
        });
    }
</script>
